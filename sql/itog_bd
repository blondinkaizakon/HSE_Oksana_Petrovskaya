/*
 * Проект: База данных судебной системы
 * Автор: Оксана Петровская
 * Версия: 1.0
 * Описание: Полная схема БД для учёта дел, участников, документов и статистики
 */

-- Создание базы данных
CREATE DATABASE IF NOT EXISTS judicial_system;
USE judicial_system;

-- Судебные округа
CREATE TABLE districts (
    district_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE,
    region VARCHAR(100)
);

-- Судьи
CREATE TABLE judges (
    judge_id INT PRIMARY KEY AUTO_INCREMENT,
    full_name VARCHAR(255) NOT NULL,
    district_id INT NOT NULL,
    hire_date DATE NOT NULL,
    FOREIGN KEY (district_id) REFERENCES districts(district_id)
);

-- Физические лица
CREATE TABLE individuals (
    individual_id INT PRIMARY KEY AUTO_INCREMENT,
    full_name VARCHAR(255) NOT NULL,
    birth_date DATE,
    phone VARCHAR(20),
    email VARCHAR(100),
    address TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_individual_phone_email (phone, email)
);

-- Юридические лица
CREATE TABLE legal_entities (
    entity_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL UNIQUE,
    inn VARCHAR(12) UNIQUE,
    ogrn VARCHAR(15) UNIQUE,
    address TEXT
);

-- Категории дел
CREATE TABLE case_categories (
    category_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT
);

-- Роли участников
CREATE TABLE participant_roles (
    role_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE
);

-- Судебные дела
CREATE TABLE cases (
    case_id INT PRIMARY KEY AUTO_INCREMENT,
    case_number VARCHAR(50) NOT NULL UNIQUE,
    category_id INT NOT NULL,
    district_id INT NOT NULL,
    judge_id INT,
    status ENUM('в рассмотрении', 'завершено', 'закрыто', 'снято') DEFAULT 'в рассмотрении',
    open_date DATE NOT NULL,
    close_date DATE,
    result ENUM('удовлетворено', 'отказано', 'частично удовлетворено', 'без решения') NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CHECK (open_date <= COALESCE(close_date, open_date)),
    FOREIGN KEY (category_id) REFERENCES case_categories(category_id),
    FOREIGN KEY (district_id) REFERENCES districts(district_id),
    FOREIGN KEY (judge_id) REFERENCES judges(judge_id)
);

-- Участники дела
CREATE TABLE case_participants (
    id INT PRIMARY KEY AUTO_INCREMENT,
    case_id INT NOT NULL,
    individual_id INT NULL,
    entity_id INT NULL,
    role_id INT NOT NULL,
    FOREIGN KEY (case_id) REFERENCES cases(case_id) ON DELETE CASCADE,
    FOREIGN KEY (individual_id) REFERENCES individuals(individual_id) ON DELETE CASCADE,
    FOREIGN KEY (entity_id) REFERENCES legal_entities(entity_id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES participant_roles(role_id),
    UNIQUE KEY uk_case_participant_role (case_id, individual_id, entity_id, role_id)
);

-- Документы по делу
CREATE TABLE documents (
    document_id INT PRIMARY KEY AUTO_INCREMENT,
    case_id INT NOT NULL,
    judge_id INT,
    title VARCHAR(255) NOT NULL,
    content TEXT,
    issue_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (case_id) REFERENCES cases(case_id) ON DELETE CASCADE,
    FOREIGN KEY (judge_id) REFERENCES judges(judge_id)
);

-- Тестовые данные
INSERT INTO districts (name, region) VALUES 
('Московский', 'Москва'),
('Санкт-Петербургский', 'СПб');

INSERT INTO judges (full_name, district_id, hire_date) VALUES 
('Иванова А.Б.', 1, '2020-03-15'),
('Петров С.В.', 2, '2018-07-22');

INSERT INTO case_categories (name) VALUES 
('Гражданские'),
('Арбитражные');

INSERT INTO participant_roles (name) VALUES 
('истец'),
('ответчик'),
('адвокат истца'),
('адвокат ответчика');

INSERT INTO individuals (full_name, birth_date, phone, email) VALUES 
('Сидоров Пётр Алексеевич', '1985-03-12', '+79051234567', 'sidorov@example.com'),
('Кузнецов Дмитрий Игоревич', '1990-08-22', '+79159876543', 'kuznetsov@example.com');

INSERT INTO cases (case_number, category_id, district_id, judge_id, open_date, close_date, status, result) VALUES 
('А40-123456/2024', 1, 1, 1, '2024-01-10', '2024-03-15', 'завершено', 'удовлетворено'),
('А40-123457/2024', 1, 1, 1, '2024-02-01', '2024-04-10', 'завершено', 'отказано'),
('А40-123458/2024', 2, 2, 2, '2024-05-05', NULL, 'в рассмотрении', NULL);

INSERT INTO case_participants (case_id, individual_id, role_id) VALUES 
(1, 1, 1),  -- Сидоров — истец в деле 1
(1, 2, 2),  -- Кузнецов — ответчик в деле 1
(2, 1, 1);  -- Сидоров — истец в деле 2

-- ===========================================================================
-- ЗАПРОСЫ
-- ===========================================================================

-- 1. Список дел, в которых участвует определённое лицо (физ.)
SELECT c.case_number, pr.name AS role, i.full_name
FROM cases c
JOIN case_participants cp ON c.case_id = cp.case_id
JOIN individuals i ON cp.individual_id = i.individual_id
JOIN participant_roles pr ON cp.role_id = pr.role_id
WHERE i.full_name = 'Сидоров Пётр Алексеевич';

-- 2. Список дел, над которыми работает конкретный судья
SELECT c.case_number, j.full_name, c.open_date
FROM cases c
JOIN judges j ON c.judge_id = j.judge_id
WHERE j.full_name = 'Иванова А.Б.';

-- 3. Средняя продолжительность рассмотрения дел судьёй
SELECT 
    j.full_name,
    AVG(DATEDIFF(c.close_date, c.open_date)) AS avg_days
FROM cases c
JOIN judges j ON c.judge_id = j.judge_id
WHERE c.status = 'завершено' AND c.close_date IS NOT NULL
GROUP BY j.judge_id;

-- 4. Рейтинг судей по количеству рассмотренных дел
SELECT 
    j.full_name,
    COUNT(*) AS total_cases
FROM judges j
JOIN cases c ON j.judge_id = c.judge_id
WHERE c.status = 'завершено'
GROUP BY j.judge_id
ORDER BY total_cases DESC;

-- 5. Судьи, рассмотревшие >1 дела за последний год
SELECT 
    j.full_name,
    COUNT(*) AS cases_last_year
FROM judges j
JOIN cases c ON j.judge_id = c.judge_id
WHERE c.open_date >= DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
GROUP BY j.judge_id
HAVING COUNT(*) > 1;

-- 6. Юрлица, выигравшие >50% дел по категории (пример для физ. лиц, т.к. юрлица не вставлены)
WITH plaintiff_stats AS (
    SELECT 
        i.full_name,
        cc.name AS category,
        COUNT(*) AS total,
        SUM(CASE WHEN c.result = 'удовлетворено' THEN 1 ELSE 0 END) AS wins
    FROM cases c
    JOIN case_participants cp ON c.case_id = cp.case_id
    JOIN individuals i ON cp.individual_id = i.individual_id
    JOIN case_categories cc ON c.category_id = cc.category_id
    JOIN participant_roles pr ON cp.role_id = pr.role_id
    WHERE pr.name = 'истец'
    GROUP BY i.individual_id, cc.category_id
)
SELECT 
    full_name,
    category,
    total,
    wins,
    ROUND(wins / total * 100, 1) AS win_rate_percent
FROM plaintiff_stats
WHERE total >= 2 AND wins / total > 0.5;

-- 7. Категории с наибольшим % неудачных исходов
SELECT 
    cc.name AS category,
    COUNT(*) AS total,
    SUM(CASE WHEN c.result = 'отказано' THEN 1 ELSE 0 END) AS denied,
    ROUND(SUM(CASE WHEN c.result = 'отказано' THEN 1 ELSE 0 END) / COUNT(*) * 100, 1) AS deny_rate_percent
FROM cases c
JOIN case_categories cc ON c.category_id = cc.category_id
WHERE c.status = 'завершено'
GROUP BY cc.category_id
ORDER BY deny_rate_percent DESC;

-- 8. Физлица, выигравшие все свои дела, и судьи этих дел
WITH perfect_winners AS (
    SELECT 
        i.individual_id,
        i.full_name,
        COUNT(*) AS total_cases
    FROM cases c
    JOIN case_participants cp ON c.case_id = cp.case_id
    JOIN individuals i ON cp.individual_id = i.individual_id
    JOIN participant_roles pr ON cp.role_id = pr.role_id
    WHERE pr.name = 'истец' AND c.status = 'завершено'
    GROUP BY i.individual_id
    HAVING SUM(CASE WHEN c.result = 'удовлетворено' THEN 1 ELSE 0 END) = COUNT(*)
      AND COUNT(*) >= 1
)
SELECT 
    pw.full_name AS plaintiff,
    j.full_name AS judge,
    c.case_number
FROM perfect_winners pw
JOIN case_participants cp ON pw.individual_id = cp.individual_id
JOIN cases c ON cp.case_id = c.case_id
JOIN judges j ON c.judge_id = j.judge_id
WHERE c.result = 'удовлетворено';

-- 9. Динамика количества дел по категориям за периоды
SELECT 
    cc.name AS category,
    YEAR(c.open_date) AS year,
    COUNT(*) AS cases_count
FROM cases c
JOIN case_categories cc ON c.category_id = cc.category_id
WHERE c.open_date >= '2024-01-01'
GROUP BY cc.category_id, YEAR(c.open_date)
ORDER BY category, year;

-- 10. Судебные округа с лучшей статистикой по категории (по % удовлетворённых)
SELECT 
    d.name AS district,
    cc.name AS category,
    COUNT(*) AS total,
    ROUND(AVG(CASE WHEN c.result = 'удовлетворено' THEN 1.0 ELSE 0 END) * 100, 1) AS satisfaction_rate
FROM cases c
JOIN districts d ON c.district_id = d.district_id
JOIN case_categories cc ON c.category_id = cc.category_id
WHERE c.status = 'завершено'
GROUP BY d.district_id, cc.category_id
HAVING total >= 1
ORDER BY category, satisfaction_rate DESC;

-- 11. Добавление нового участника (физ. лица)
INSERT INTO individuals (full_name, birth_date, phone, email)
VALUES ('Новиков Алексей Сергеевич', '1988-11-30', '+79261112233', 'novikov@example.com');

-- 12. Обновление контактной информации участника по ФИО
UPDATE individuals 
SET email = 'sidorov.updated@example.com', phone = '+79998887766'
WHERE full_name = 'Сидоров Пётр Алексеевич';

-- 13. Удаление дела, закрытого/снятого с рассмотрения (пример удаления дела 2)
DELETE FROM cases WHERE case_id = 2 AND status IN ('закрыто', 'снято');
-- Примечание: ON DELETE CASCADE автоматически удалит записи в case_participants и documents

-- 14. Добавление нового судебного документа
INSERT INTO documents (case_id, judge_id, title, issue_date)
VALUES (
    1, 
    (SELECT judge_id FROM cases WHERE case_id = 1),
    'Решение суда',
    CURDATE()
);
